package com.nabla.sdk.core.data.exception

import com.apollographql.apollo3.exception.ApolloException
import okhttp3.Response
import java.math.BigDecimal

internal class GraphQLException(
    val error: com.apollographql.apollo3.api.Error,
    context: Response,
) : ApolloException(error.message) {
    private val extensions = error.nonStandardFields?.get("extensions") as? Map<*, *>

    val numericCode: Int? = (extensions?.get("errorCode") as? BigDecimal)?.toInt()
    val errorCode: ErrorCode? = getErrorCodeFromNumericCode(numericCode)
    val serverMessage: String = error.message

    // not always present, but if so it's useful debugging information
    val optionalDetailedMessage: String? = extensions?.get("detailedMessage") as? String

    val requestId: String? = (context.networkResponse)?.header(REQUEST_ID_HEADER_NAME)

    companion object {
        private const val REQUEST_ID_HEADER_NAME = "x-request-id"
        private val codeToError = ErrorCode.values().associateBy { it.code }
        private fun getErrorCodeFromNumericCode(numericCode: Int?): ErrorCode? = codeToError[numericCode]
    }
}

// TODO codegen this
internal enum class ErrorCode(
    val code: Int
) {
    /**
     * ----- Generic HTTP-like error codes.
     */
    BAD_REQUEST(400),
    INTERNAL_SERVER_ERROR(500),
    /**
     * ----- Generic authorization errors. (new errors should be in range 10k+)
     */
    ACCESS_TO_ENTITY_UNAUTHORIZED(10000),
    PERMISSION_REQUIRED(10001),
    ILLEGAL_ACCESS_TO_MEDICAL_DATA(10012),
    ILLEGAL_ACCESS_TO_ADMINISTRATIVE_DATA(10013),
    INVALID_ANTI_SPAM_TOKEN(10016),
    IDENTIFIER_NOT_WHITELISTED(10017),
    AUTO_ACCESS_CHECK_FAILURE(10018),
    /**
     * ----- Generic errors for unconditionally bad user inputs. (new errors should be in range 30k+)
     */
    MISSING_PHONE_NUMBER_COUNTRY_CODE(30001),
    INVALID_EMAIL(30002),
    INVALID_PHONE(30003),
    INSECURE_PASSWORD(30004),
    INVALID_NAME(30005),
    BAD_PAGINATION_CURSOR(30020),
    INVALID_DOCTOR_RECOMMENDATION_INPUT(30100),
    INVALID_SCALE_INPUT(30101),
    DID_NOT_PROVIDE_AN_EXPERIENCE_UUID_TO_MARK_AS_SEEN(30102),
    /**
     * ----- Generic 'bad state' errors. (new errors should be in range 40k+)
     */
    ENTITY_NOT_FOUND(20000),
    DOCTOR_IS_NOT_INVITED(30022),
    ENTITY_ALREADY_EXISTS(40000),
    ENTITY_IS_NOT_UNIQUE(40052),
    GATEKEEPER_NOT_ENABLED(40051),
    /**
     * ----- Calls. (new errors should be in range 41k+)
     */
    USER_NOT_IN_CALL(41000),
    USER_ALREADY_IN_A_CALL(41001),
    CALLING_INVALID_DOCTOR_UUID(41003),
    CALLING_INVALID_PATIENT_UUID(41004),
    INVALID_STATUS_IN_CALL(41005),
    A_PARTICIPANT_IS_IN_ANOTHER_CALL(41006),
    CALL_NOTIFICATION_FAILED(41007),
    UNABLE_TO_JOIN_ENDED_CALL(41009),
    /**
     * ----- Billing. (new errors should be in range 42k+)
     */
    BILL_IS_ALREADY_FINALIZED(42000),
    DOCTOR_MUST_HAVE_STRIPE_ACCOUNT_TO_SETUP_BILLING(42002),
    ATTEMPTED_TO_CHARGE_FOR_FREE_APPOINTMENT(42003),
    DOCTOR_DOES_NOT_HAVE_STRIPE_ACCOUNT(42005),
    BILL_PATIENT_IS_DELETED(42007),
    INVALID_BILL_PRICE(42009),
    BILL_DOCTOR_IS_DELETED(42010),
    PRICE_MAJORATION_NOT_AUTHORIZED(42011),
    CANNOT_PAY_BILL(42012),
    /**
     * ----- Appointments and availabilities (new errors should be in range 43k+)
     */
    UNAUTHORIZED_APPOINTMENT_FORMAT_EDITION_ATTEMPT(10007),
    INVALID_APPOINTMENT_FORMAT_EDITION_ATTEMPT(10011),
    UNAUTHORIZED_APPOINTMENT_AVAILABILITY_EDITION(10015),
    EVENT_MUST_BE_NON_RECURRENT(30017),
    INVALID_RRULE_FOR_CALENDAR_EVENT(30018),
    EVENT_MUST_BE_RECURRENT(30024),
    INVALID_APPOINTMENT_CREATION_INPUT(40032),
    APPOINTMENT_SLOT_INCOMPATIBLE_WITH_DOCTOR_SCHEDULE(40033),
    APPOINTMENT_SLOT_INCOMPATIBLE_WITH_PATIENT_SCHEDULE(40034),
    PATIENT_CAN_NOT_CANCEL_PAST_APPOINTMENT(40040),
    INVALID_APPOINTMENT_FINALIZATION_INPUT(42004),
    ATTEMPTED_TO_CANCEL_FINALIZED_APPOINTMENT(42006),
    APPOINTMENT_FORMAT_OUT_OF_DATE(42008),
    UNAUTHORIZED_ADDRESS_EDITION(43001),
    INVALID_APPOINTMENT_FORMAT_CHANNEL_ADDRESS_CREATION_ATTEMPT(43002),
    APPOINTMENT_FORMAT_INCOMPATIBLE_WITH_CHANNEL(43003),
    APPOINTMENT_AVAILABILITY_INCOMPATIBLE_WITH_CHANNEL(43004),
    UNAUTHORIZED_APPOINTMENT_CREATION(43006),
    CALENDAR_EVENTS_MUST_BE_ALIGNED_ON_THE_SECOND(43007),
    INVALID_AVAILABILITY_STATE_TO_DELETE(43008),
    /**
     * ----- Health questionnaire. (new errors should be in range 44k+)
     */
    HEALTH_QUESTIONNAIRE_NOT_FOUND(20008),
    NULL_QUESTIONNAIRE(30014),
    QUESTIONNAIRE_NOT_SUBMITTED(30015),
    QUESTIONNAIRE_ALREADY_IMPORTED(30016),
    /**
     * ----- EHR. (new errors should be in range 45k+)
     */
    TAG_BLANK(30009),
    OBJECTIVE_INPUT_NOT_IN_PATIENT_OBJECTIVES(45001),
    INPUT_VALUE_NOT_IN_PATIENT_OTHER_OBJECTIVES(45002),
    ACCESSOR_CANNOT_DELETE_EHR_ITEM(45004),
    ONLY_AUTHOR_CAN_EDIT_DOCUMENT_DRAFT(45005),
    WRONG_PATIENT_FOR_CONDITION(45006),
    ONLY_DATA_POINTS_FROM_WEBAPP_CAN_BE_EDITED(45007),
    ACCESSOR_CANNOT_UPDATED_EXTRACTION_STATUS(45008),
    /**
     * ----- Experiences. (new errors should be in range 46k+)
     */
    CANNOT_UPDATE_MAIN_EXPERIENCE(10008),
    EXPERIENCE_ALREADY_CLOSED(40013),
    EXPERIENCE_NOT_CLOSED(40014),
    INVALID_MESSAGE_SENDER(40023),
    EXPERIENCE_CANNOT_HAVE_SINGLE_USER(40030),
    USER_NOT_IN_EXPERIENCE(40031),
    PATIENT_ALREADY_ARCHIVED(40036),
    DOCTOR_NON_PLATFORM_USER_CANNOT_BE_IN_EXPERIENCE(40049),
    CANNOT_SEND_DELETED_MESSAGE(40050),
    PATIENT_NOT_ARCHIVED(46000),
    NON_PLATFORM_DOCTOR_CANNOT_BE_LINKED_TO_PUBLICLY_LISTED_PRACTITIONER(46001),
    EXPERIENCE_ALREADY_ASSIGNED(46002),
    ONLY_QA_EXPERIENCE_CAN_HAVE_TAG(46004),
    NOT_A_QA_EXPERIENCE(46005),
    INVALID_RATING(30035),
    NO_REACTION_TO_MESSAGE_IN_EXPERIENCE_WITH_PATIENT(46007),
    CANNOT_EDIT_DELETED_MESSAGE(46008),
    NOT_A_DOCTOR_EXPERIENCE(46009),
    ACTION_REQUEST_INPUT_IN_PATIENT_MESSAGE(46010),
    INVALID_SOS_THEME(46011),
    CANNOT_CREATE_EXPERIENCE_IF_NOT_SUBSCRIBED(46012),
    ONLY_ONE_SCHEDULED_MESSAGE_BY_EXPERIENCE(46013),
    INVALID_EXPERIENCE_PATIENT(46014),
    USER_NOT_AUTHORIZED_TO_DELETE_MESSAGE(46015),
    UNEXPECTED_ACTION_REQUEST_TYPE(46016),
    INVALID_QUESTIONNAIRE_FOR_REGION(46017),
    NO_MESSAGES_FROM_DOCTOR(46018),
    CANNOT_CREATE_PATHWAY_EXPERIENCE_IF_NO_PATHWAY(46019),
    UNAUTHORIZED_TO_ASSIGN_THIS_DOCTOR(46020),
    CANNOT_QUERY_THE_COPILOT_IF_NOT_A_PATIENT_EXPERIENCE(46021),
    /**
     * ----- Device & notifications. (new errors should be in range 48k+)
     */
    UNAUTHORIZED_REMOVE_DEVICE_ATTEMPT(10014),
    DEVICE_HAS_NO_USER(20005),
    INCONSISTENT_DEVICE(40018),
    DEVICE_BELONGS_TO_ANOTHER_USER(48000),
    /**
     * ----- Doctor profile. (new errors should be in range 49k+)
     */
    AVATAR_TOO_BIG(30006),
    /**
     * ----- Doctor registration & admin operations. (new errors should be in range 50k+)
     */
    ADMIN_CANNOT_SEE_MEDICAL_DATA(10010),
    MATCHING_DEACTIVATED_DOCTOR_ALREADY_EXISTS(40003),
    DOCTOR_ALREADY_REGISTERED(40007),
    DOCTOR_NOT_REGISTERED(40035),
    INVALID_OTP(40044),
    INVALID_DOCTOR_CREDENTIALS(40047),
    ENTITY_ALREADY_EXISTS_FOR_PUBLICLY_REGISTERED_PRACTITIONER(50001),
    DOCTOR_IS_INVITED(50002),
    INVALID_RPPS(50003),
    INVALID_ADELI_NUMBER(50004),
    INVALID_AM_NUMBER(50005),
    OPERATION_REQUIRES_A_DEACTIVATED_DOCTOR(50006),
    OPERATION_REQUIRES_AN_ACTIVE_DOCTOR(50007),
    INVALID_GATEKEEPER_UPDATE_INPUT(50008),
    ONLY_FRENCH_DOCTORS_CAN_BE_LINK_TO_PUBLIC_PRACTITIONER(50009),
    INVALID_GMC_NUMBER(50010),
    ONLY_EMPLOYEE_CAN_BE_SUBSCRIBED_FROM_BACKOFFICE(50011),
    /**
     * ----- Patient registration & admin operations. (new errors should be in range 51k+)
     */
    PATIENT_WITH_PHONE_NOT_FOUND(20004),
    PATIENT_ACCOUNT_LOCKED(40008),
    PATIENT_NOT_REGISTERED(40011),
    PATIENT_NOT_IN_RECOVERY_MODE(40012),
    COULD_NOT_SEND_WHATSAPP_GREETING(40025),
    PATIENT_ALREADY_REGISTERED(40042),
    INVALID_PATIENT_ACCOUNT_TYPE(51002),
    INVALID_USERNAME(51004),
    USERNAME_ALREADY_IN_USE(51005),
    INVITATION_CODE_NOT_FOUND(51006),
    INVITATION_CODE_INVALID(51007),
    INVALID_PATIENT_AGE(51011),
    INVITATION_CODE_REQUIRED(51012),
    SECONDARY_INFORMATION_FOR_PATIENT_RECOVERY_INCORRECT(51013),
    CANNOT_BAN_DOCTOR(51014),
    COMMENT_HAS_NO_PATIENT_AUTHOR(51015),
    COMMENT_ALREADY_ASSIGNED(51016),
    CANNOT_CHANGE_DOCTOR_COMMENT_STATE(51017),
    COMMENT_NOT_ASSIGNED(51018),
    PATIENT_ALREADY_USED_AN_INVITATION_CODE(51019),
    INVALID_REGION_FOR_INVITATION_CODE(51020),
    /**
     * ----- Dataset. (new errors should be in range 52k+)
     */
    ONLY_DATASET_OWNER_CAN_UPLOAD_FILES(40027),
    /**
     * ----- Log anything. (new errors should be in range 54k+)
     */
    FORM_MISSING_FIELD(54000),
    FORM_MISSING_FIELD_VALUE(54001),
    FORM_INVALID_EMPTY_TEXT(54002),
    FORM_INVALID_FUTURE_DATE(54003),
    FORM_INVALID_CHOICE(54004),
    FORM_INVALID_DURATION(54005),
    FORM_DEPRECATED(54006),
    ACCESSOR_CANNOT_DELETE_SUBMITTED_FORM(54007),
    /**
     * ----- FileUpload (new errors should be in range 55k+)
     */
    CANNOT_DELETE_FILE_USED_IN_SEVERAL_CONTEXTS(55001),
    /**
     * ----- External assets (new errors should be in range 56k+)
     */
    CANNOT_REACH_DRUG_SERVER(56001),
    PUBLICLY_LISTED_DRUG_NOT_FOUND_FOR_EXTERNAL_ID(56002),
    /**
     * ----- Stories and comments (new errors should be in range 57k+)
     */
    CANNOT_CREATE_EMPTY_COMMENT(57001),
    CANNOT_DELETE_OTHER_USERS_COMMENTS(57002),
    CANNOT_REPLY_TO_A_REPLY(57003),
    INCOMPATIBLE_COMMENT_STORIES(57004),
    CANNOT_EDIT_OTHER_USERS_COMMENTS(57005),
    CANNOT_UPDATE_DELETED_COMMENT(57006),
    EXPECTED_A_PATIENT_USER_COMMENT_ACTIVITY(57007),
    CANNOT_UNFOLLOW_A_COMMENT_NOT_FOLLOWED(57008),
    STORY_OF_TYPE_QUESTION_OF_THE_DAY_MUST_HAVE_A_PREVIEW(57009),
    ONLY_AUTHOR_CAN_EDIT_REVIEW_COMMENT(57010),
    READY_STORIES_MUST_HAVE_A_DATE(57011),
    STORIES_CAN_ONLY_BE_PUBLISHED_BY_CONTENT_MANAGERS(57012),
    CANNOT_EDIT_ACTIONABLE_STORY(57013),
    WEEKLY_PROGRAM_MUST_BE_TIME_SENSITIVE(57014),
    /**
     * ----- Verification codes (new errors should be in range 58k+)
     */
    PHONE_VERIFICATION_LOCKED(51008),
    EMAIL_VERIFICATION_LOCKED(51009),
    INVALID_VERIFICATION_CODE(40006),
    EXPIRED_VERIFICATION_CODE(58001),
    ALREADY_USED_VERIFICATION_CODE(58002),
    VERIFICATION_CODE_RATE_LIMIT_EXCEEDED(58003),
    VERIFICATION_CODE_INVALIDATED_BY_MORE_RECENT_CODES(58004),
    /**
     * ----- Mentions (new errors should be in range 59k+)
     */
    WRONG_INPUT_FOR_MENTION(59001),
    PATIENT_CANNOT_MENTION_IN_MESSAGE(59002),
    /**
     * ----- Teleconsultation request (new errors should be in range 60k+)
     */
    UNAVAILABLE_DOCTOR(60001),
    ONLY_ACCEPTED_REQUEST_CAN_HAVE_SSN(60002),
    WRONG_TELECONSULTATION_PRICE(60003),
    TELECONSULTATION_REQUEST_ALREADY_REPLIED(60004),
    NOT_A_VALID_SSN(60005),
    PATIENT_ALREADY_HAS_TELECONSULTATION_REQUEST(60006),
    UNAUTHORIZED_TELECONSULTATION_REQUEST_CREATION_ATTEMPT(60007),
    TELECONSULTATION_REQUEST_MISSING_BILLING_PARAMETER(60009),
    DOCTOR_CANNOT_DO_TELECONSULTATION(60010),
    UNKNOWN_DOCTOR(60012),
    /**
     * ----- Programs (new errors should be in range 61k+)
     */
    INVALID_PROGRAM_CATEGORY_ID(61001),
    PROGRAM_ALREADY_JOINED(61002),
    PROGRAM_WITH_NO_FIRST_ACTION(61003),
    PROGRAM_PATIENT_ALREADY_COMPLETED(61004),
    PROGRAM_PATIENT_NOT_COMPLETABLE(61005),
    PATIENT_LEFT_THE_PROGRAM(61006),
    INVALID_ANSWER_PARENT_PROGRAM(61007),
    DUPLICATE_PROGRAM_ANSWER(61008),
    MISSING_PROGRAM_ANSWER(61009),
    INVALID_PROGRAM_CHOICE_ANSWER(61010),
    CANNOT_HIDE_STARTED_PROGRAM(61011),
    CANNOT_CHANGE_PUBLISHED_PROGRAMS_ACTIONS(61012),
    CANNOT_CHANGE_QUESTION_TYPE(61013),
    CANNOT_REMOVE_CHOICE_QUESTION_LABEL(61014),
    DUPLICATE_PROGRAM_QUESTION_INPUT(61015),
    CANNOT_UPDATE_MISSING_PROGRAM_QUESTION(61016),
    ACTION_CANNOT_BE_COMPLETED(61017),
    ALREADY_A_PROGRAM_WITH_THIS_IDENTIFIER(61018),
    PROGRAM_NOT_COMPLETED(61019),
    /**
     * ----- Identity verification (new errors should be in range 62k+)
     */
    WRONG_REGION_FOR_IDENTITY_VERIFICATION(62001),
    STRIPE_VERIFICATION_CONNECTION_ERROR(62002),
    /**
     * ----- Prescriptions (range 63k+)
     */
    DOCTOR_DOESNT_HAVE_SIGNATURE_RX_FIELDS(63000),
    PATIENT_MISSES_SIGNATURE_RX_FIELDS(63001),
    IP_ADDRESS_NOT_FOUND(63002),
    SIGNATURE_RX_PRESCRIPTION_FOR_A_NON_UK_PATIENT(63003),
    PRESCRIPTION_ALREADY_HAS_A_DOCUMENT(63004),
    TRIGGERING_SIGNATURE_RX_FOR_NON_UK_DOCTOR(63005),
    /**
     * ----- Ml models (range 64k+)
     */
    ML_MODEL_NOT_READY(64000),
    ;
}
